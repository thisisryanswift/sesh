#!/usr/bin/env bash

# sesh - unified session manager
# Combines zoxide (existing projects) + try (experiments) + zellij (sessions)

TRY_PATH="${TRY_PATH:-$HOME/src/tries}"

# Build list of directories:
# 1. Zoxide history (frecency-sorted)
# 2. Try experiments (if not already in zoxide)
get_directories() {
    # Get zoxide directories
    zoxide query --list 2>/dev/null
    
    # Add try experiments not already in zoxide
    if [[ -d "$TRY_PATH" ]]; then
        for dir in "$TRY_PATH"/*/; do
            [[ -d "$dir" ]] && echo "${dir%/}"
        done
    fi
}

# Deduplicate while preserving order (zoxide first)
dedupe() {
    awk '!seen[$0]++'
}

# Select directory with fzf
SELECTED=$(get_directories | dedupe | fzf \
    --height=100% \
    --layout=default \
    --border \
    --prompt="sesh > " \
    --header="Select project or type new experiment name" \
    --print-query \
    --bind="enter:accept-or-print-query")

# fzf --print-query outputs: line 1 = query, line 2 = selection (if any)
QUERY=$(echo "$SELECTED" | sed -n '1p')
SELECTION=$(echo "$SELECTED" | sed -n '2p')

# Nothing entered
if [[ -z "$QUERY" && -z "$SELECTION" ]]; then
    exit 0
fi

# Determine the target directory
if [[ -n "$SELECTION" ]]; then
    # User selected an existing directory
    TARGET_DIR="$SELECTION"
else
    # User typed a new name - create via try
    # Check if it looks like a date-prefixed name already
    if [[ "$QUERY" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
        TARGET_DIR="$TRY_PATH/$QUERY"
    else
        # Add date prefix
        TARGET_DIR="$TRY_PATH/$(date +%Y-%m-%d)-$QUERY"
    fi
    
    if [[ ! -d "$TARGET_DIR" ]]; then
        mkdir -p "$TARGET_DIR"
        echo "Created: $TARGET_DIR"
        # Add to zoxide so it shows up next time
        zoxide add "$TARGET_DIR"
    fi
fi

# Verify directory exists
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory does not exist: $TARGET_DIR"
    exit 1
fi

# Session name from directory basename
SESSION_NAME=$(basename "$TARGET_DIR")

# Get existing zellij sessions
SESSION_LIST=$(zellij list-sessions -n 2>/dev/null | awk '{print $1}')

# Attach or create session
if echo "$SESSION_LIST" | grep -q "^${SESSION_NAME}$"; then
    zellij attach "$SESSION_NAME"
else
    echo "Creating session: $SESSION_NAME"
    cd "$TARGET_DIR" && zellij attach -c "$SESSION_NAME"
fi
