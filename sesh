#!/usr/bin/env bash

# sesh - unified session manager
# Combines zoxide (existing projects) + try (experiments) + opencode sessions + zellij

TRY_PATH="${TRY_PATH:-$HOME/src/tries}"
OPENCODE_STORAGE="$HOME/.local/share/opencode/storage"

# Build list of all sources
get_all_items() {
    # 1. OpenCode sessions (prefixed with "oc:" for identification)
    # Parse JSON files directly for speed (skips opencode CLI overhead)
    if [[ -d "$OPENCODE_STORAGE/session/global" ]]; then
        # Use jq to extract fields, sort by updated time (descending)
        # Format: oc:SESSION_ID  TITLE
        find "$OPENCODE_STORAGE/session/global" -name "*.json" -print0 | \
        xargs -0 jq -r '[.id, .title, .time.updated] | @tsv' 2>/dev/null | \
        sort -k3 -nr | \
        while IFS=$'\t' read -r id title updated; do
            echo "oc:$id  $title"
        done
    fi
    
    # 2. Zoxide directories
    zoxide query --list 2>/dev/null
    
    # 3. Try experiments
    if [[ -d "$TRY_PATH" ]]; then
        for dir in "$TRY_PATH"/*/; do
            [[ -d "$dir" ]] && echo "${dir%/}"
        done
    fi
}

# Deduplicate while preserving order
dedupe() {
    awk '!seen[$0]++'
}

# Get the list once
ALL_ITEMS=$(get_all_items | dedupe)

# Handle arguments (lucky mode / pre-fill)
if [[ -n "$1" ]]; then
    QUERY_ARG="$*"
    
    # Try to filter with fzf
    MATCHES=$(echo "$ALL_ITEMS" | fzf --filter="$QUERY_ARG")
    MATCH_COUNT=$(echo "$MATCHES" | wc -l)
    
    if [[ -n "$MATCHES" && "$MATCH_COUNT" -eq 1 ]]; then
        # Lucky match!
        SELECTION="$MATCHES"
        QUERY="$QUERY_ARG"
    else
        # Multiple matches or no matches - open interactive picker with query
        SELECTED=$(echo "$ALL_ITEMS" | fzf \
            --height=100% \
            --layout=default \
            --border \
            --prompt="sesh > " \
            --header="Select project, opencode session (oc:), or type new experiment" \
            --query="$QUERY_ARG" \
            --print-query \
            --bind="enter:accept-or-print-query")
            
        QUERY=$(echo "$SELECTED" | sed -n '1p')
        SELECTION=$(echo "$SELECTED" | sed -n '2p')
    fi
else
    # No arguments - standard interactive mode
    SELECTED=$(echo "$ALL_ITEMS" | fzf \
        --height=100% \
        --layout=default \
        --border \
        --prompt="sesh > " \
        --header="Select project, opencode session (oc:), or type new experiment" \
        --print-query \
        --bind="enter:accept-or-print-query")
        
    QUERY=$(echo "$SELECTED" | sed -n '1p')
    SELECTION=$(echo "$SELECTED" | sed -n '2p')
fi

# Nothing entered
if [[ -z "$QUERY" && -z "$SELECTION" ]]; then
    exit 0
fi

# Check if selection is an opencode session
if [[ "$SELECTION" == oc:* ]]; then
    # Extract session ID
    SESSION_ID=$(echo "$SELECTION" | cut -d: -f2 | awk '{print $1}')
    
    # Find the session's directory from the JSON files
    SESSION_DIR=""
    # Use the session file directly since we have the ID
    SESSION_FILE="$OPENCODE_STORAGE/session/global/${SESSION_ID}.json"
    if [[ -f "$SESSION_FILE" ]]; then
        SESSION_DIR=$(jq -r .directory "$SESSION_FILE" 2>/dev/null)
    fi
    
    # Fallback to home if not found
    if [[ -z "$SESSION_DIR" || ! -d "$SESSION_DIR" ]]; then
        SESSION_DIR="$HOME"
    fi
    
    TARGET_DIR="$SESSION_DIR"
    OPENCODE_ARGS="-s $SESSION_ID"
elif [[ -n "$SELECTION" ]]; then
    # User selected an existing directory
    TARGET_DIR="$SELECTION"
    OPENCODE_ARGS="-c"
else
    # User typed a new name - create via try
    if [[ "$QUERY" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}- ]]; then
        TARGET_DIR="$TRY_PATH/$QUERY"
    else
        TARGET_DIR="$TRY_PATH/$(date +%Y-%m-%d)-$QUERY"
    fi
    
    if [[ ! -d "$TARGET_DIR" ]]; then
        mkdir -p "$TARGET_DIR"
        echo "Created: $TARGET_DIR"
        zoxide add "$TARGET_DIR"
    fi
    # New experiment: start fresh opencode session (don't continue)
    OPENCODE_ARGS=""
fi

# Verify directory exists
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory does not exist: $TARGET_DIR"
    exit 1
fi

# Export for zellij layout to pick up
export OPENCODE_ARGS

# Session name from directory basename
SESSION_NAME=$(basename "$TARGET_DIR")

# Get existing zellij sessions
SESSION_LIST=$(zellij list-sessions -n 2>/dev/null | awk '{print $1}')

# Attach or create zellij session
if echo "$SESSION_LIST" | grep -q "^${SESSION_NAME}$"; then
    zellij attach "$SESSION_NAME"
else
    echo "Creating session: $SESSION_NAME"
    cd "$TARGET_DIR" && zellij attach -c "$SESSION_NAME"
fi
